services:
  docker-sshd-e2e-target:
    image: alpine:3.20
    container_name: docker-sshd-e2e-test
    command: ["sleep", "300"]
  e2e-runner:
    build:
      context: ..
      dockerfile: e2e/Dockerfile.testrunner
    depends_on:
      - docker-sshd-e2e-target
    network_mode: host
    working_dir: /src
    environment:
      - KUBECONFIG=/root/.kube/config
    volumes:
      - ..:/src
      - /var/run/docker.sock:/var/run/docker.sock
      - ${KUBECONFIG:-/tmp/invalid-kubeconfig-path}:/root/.kube/config:ro
    command:
      - /bin/sh
      - -ec
      - |
        export GOFLAGS=-buildvcs=false
        mkdir -p /tmp/bin
        go build -o /tmp/bin/docker-sshd ./cmd/docker-sshd
        go build -o /tmp/bin/kube-sshd ./cmd/kube-sshd
        DOCKER_SSHD_E2E=$${DOCKER_SSHD_E2E:-1} \
        KUBE_SSHD_E2E=$${KUBE_SSHD_E2E:-1} \
        DOCKER_SSHD_BIN=/tmp/bin/docker-sshd \
        KUBE_SSHD_BIN=/tmp/bin/kube-sshd \
        go test ./e2e -v
